{% extends "base.html" %}
{% load static %}
{% block title %}Chat with {{ other_user.username }}{% endblock %}

{% block content %}
<div class="flex flex-col h-screen bg-gray-50 dark:bg-gray-900">

  <!-- Header -->
  <header class="flex items-center gap-3 px-4 py-3 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 sticky top-0 z-10">
    <img src="{% if other_user.profile.profile_pic %}{{ other_user.profile.profile_pic.url }}{% else %}{% static 'images/default.jpg' %}{% endif %}" 
         alt="{{ other_user.username }}'s profile picture" 
         class="w-10 h-10 rounded-full object-cover">
    <div class="flex flex-col">
      <span class="font-semibold text-gray-800 dark:text-gray-100">{{ other_user.username }}</span>
      {% if is_online %}
        <span class="text-xs text-green-500">● Online</span>
      {% else %}
        <span class="text-xs text-gray-400">Last seen {{ last_seen|timesince }} ago</span>
      {% endif %}
    </div>
  </header>

  <!-- Messages -->
  <div id="chat-box" class="flex-1 overflow-y-auto px-4 py-3 space-y-3">
    {% for message in messages %}
      <div class="flex items-end {% if message.sender == request.user %}justify-end{% endif %}">
        {% if message.sender != request.user %}
          <img src="{% if message.sender.profile.profile_pic %}{{ message.sender.profile.profile_pic.url }}{% else %}{% static 'images/default.jpg' %}{% endif %}" 
               class="w-7 h-7 rounded-full mr-2" 
               alt="{{ message.sender.username }}'s profile picture">
        {% endif %}
        <div class="max-w-xs md:max-w-sm px-4 py-2 rounded-2xl text-sm shadow-sm
                    {% if message.sender == request.user %}bg-blue-500 text-white rounded-br-none{% else %}bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-bl-none{% endif %}">
          <p>{{ message.message|escape }}</p>
          <div class="text-[10px] mt-1 opacity-70 flex items-center gap-1">
            {{ message.timestamp|date:"H:i" }}
            {% if message.sender == request.user %}
              <span id="dot-{{ message.id }}" 
                    class="{% if message.is_read %}text-blue-300{% else %}text-gray-300{% endif %}">✓✓</span>
            {% endif %}
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- Input Area -->
  <form id="message-form" class="flex items-center gap-3 px-4 py-3 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 sticky bottom-0">
    {% csrf_token %}
    <input
      id="message-input"
      name="message"
      type="text"
      autocomplete="off"
      placeholder="Type a message..."
      class="flex-grow px-4 py-2 rounded-2xl border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 text-sm text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
      aria-label="Type a message to {{ other_user.username }}"
    />
    <button type="submit" 
            class="flex items-center justify-center w-10 h-10 rounded-full text-blue-500 hover:text-blue-600 transition transform hover:scale-110"
            aria-label="Send message">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
        <path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/>
      </svg>
    </button>
  </form>

</div>

{% block scripts %}
<script>
  // Utility: escape HTML to prevent JS errors from user input
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Scroll chat to bottom
  const chatBox = document.getElementById('chat-box');
  if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;

  // WebSocket setup
  const chatSocket = new WebSocket(
    (location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host + '/ws/chat/{{ other_user.username }}/'
  );

  chatSocket.onopen = () => {
    chatSocket.send(JSON.stringify({ action: 'mark_read' }));
  };

  chatSocket.onmessage = event => {
    const data = JSON.parse(event.data);

    if (data.error) {
      console.error('WebSocket error:', data.error);
      return;
    }

    // Read receipt handling
    if (data.type === 'read_receipt') {
      data.message_ids.forEach(id => {
        const dot = document.querySelector(`#dot-${id}`);
        if (dot) dot.classList.replace('text-gray-300', 'text-blue-300');
      });
      return;
    }

    // Message rendering
    const isMe = data.sender === "{{ request.user.username }}";
    const wrapper = document.createElement('div');
    wrapper.className = 'flex items-end ' + (isMe ? 'justify-end' : '');

    if (!isMe) {
      const avatar = document.createElement('img');
      avatar.src = "{% if other_user.profile.profile_pic %}{{ other_user.profile.profile_pic.url }}{% else %}{% static 'images/default.jpg' %}{% endif %}";
      avatar.className = 'w-7 h-7 rounded-full mr-2';
      avatar.alt = "{{ other_user.username }}'s profile picture";
      wrapper.appendChild(avatar);
    }

    const bubble = document.createElement('div');
    bubble.className = 'max-w-xs md:max-w-sm px-4 py-2 rounded-2xl text-sm shadow-sm ' +
      (isMe ? 'bg-blue-500 text-white rounded-br-none' : 'bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-bl-none');

    bubble.innerHTML = `
      <p>${escapeHtml(data.message)}</p>
      <div class="text-[10px] mt-1 opacity-70 flex items-center gap-1">
        ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
        ${isMe ? `<span id="dot-${data.id}" class="${data.is_read ? 'text-blue-300' : 'text-gray-300'}">✓✓</span>` : ''}
      </div>
    `;

    wrapper.appendChild(bubble);
    chatBox.appendChild(wrapper);
    chatBox.scrollTop = chatBox.scrollHeight;
  };

  chatSocket.onerror = () => console.error('WebSocket error');
  chatSocket.onclose = () => console.log('WebSocket closed');

  // Sending messages
  const messageForm = document.getElementById('message-form');
  messageForm.addEventListener('submit', e => {
    e.preventDefault();
    const input = document.getElementById('message-input');
    const text = input.value.trim();
    if (!text || chatSocket.readyState !== WebSocket.OPEN) return;

    chatSocket.send(JSON.stringify({
      message: text,
      receiver: "{{ other_user.username }}"
    }));
    input.value = '';
  });
</script>
{% endblock %}
{% endblock %}
