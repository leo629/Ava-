{% load static %}
{% load crispy_forms_tags %}
<!DOCTYPE html>
<html lang="en" class="transition-colors duration-300">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <title>{% block title %}Ava Dating{% endblock %}</title>
  <link rel="icon" type="image/png" href="{% static 'favicon.png' %}" />

  <!-- Dark Mode Preload -->
  <script>
    (function() {
      const theme = localStorage.getItem('theme') || 'light';
      if (theme === 'dark') document.documentElement.classList.add('dark');
    })();
  </script>

  <!-- Tailwind Config -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          animation: {
            'fade-in': 'fadeIn 0.5s ease-in-out',
            'slide-up': 'slideUp 0.3s ease-out',
            'slide-right': 'slideRight 0.3s ease-out'
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
            slideRight: { '0%': { transform: 'translateX(100%)' }, '100%': { transform: 'translateX(0)' } }
          }
        }
      }
    };
  </script>

  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="stylesheet" href="{% static 'css/account.css' %}" />
  {% block extra_head %}{% endblock %}
</head>

<body class="bg-gray-100 text-gray-900 dark:bg-gray-900 dark:text-gray-100 font-sans transition duration-300">

<!-- Navbar -->
<nav class="bg-black text-white shadow-lg dark:bg-gray-800">
  <div class="container mx-auto px-4 flex justify-between items-center py-3">

    <!-- Logo -->
    <a href="/" class="text-xl font-bold tracking-wide flex items-center gap-1">
      meet
    </a>

    <!-- Desktop Nav -->
    <ul class="hidden md:flex gap-6 text-sm items-center">
      {% if user.is_authenticated %}
        <li><a href="{% url 'user_profile' %}" class="flex items-center gap-1 hover:text-pink-500"><i data-lucide="user" class="w-5 h-5"></i>Profile</a></li>
        <li><a href="{% url 'edit_profile' %}" class="flex items-center gap-1 hover:text-pink-500"><i data-lucide="edit" class="w-5 h-5"></i>Edit</a></li>
        <li><a href="{% url 'chat_list' %}" class="flex items-center gap-1 hover:text-pink-500 relative"><i data-lucide="message-circle" class="w-5 h-5"></i>Chat<span id="chat-notification-count" class="absolute -top-2 -right-3 bg-red-500 text-xs px-1 rounded-full hidden">0</span></a></li>
        <li><a href="{% url 'swipes:swipe_page' %}" class="flex items-center gap-1 hover:text-pink-500"><i data-lucide="heart" class="w-5 h-5"></i>Swipe</a></li>
        <li><a href="{% url 'who_liked_me' %}" class="flex items-center gap-1 hover:text-pink-500"><i data-lucide="thumbs-up" class="w-5 h-5"></i>Likes</a></li>
        <li><a href="{% url 'match_results' %}" class="flex items-center gap-1 hover:text-pink-500"><i data-lucide="users" class="w-5 h-5"></i>Matches</a></li>
        <li id="notification-wrapper" class="relative cursor-pointer"><i data-lucide="bell" class="w-5 h-5 hover:text-pink-500"></i><span id="notification-count" class="absolute -top-2 -right-2 bg-red-500 text-xs px-1 rounded-full hidden">0</span><div id="notification-dropdown" class="hidden absolute right-0 mt-2 w-64 bg-white dark:bg-gray-700 shadow-lg rounded-lg overflow-hidden z-50"></div></li>
        <li><a href="{% url 'account_logout' %}" class="flex items-center gap-1 hover:text-pink-500"><i data-lucide="log-out" class="w-5 h-5"></i>Logout</a></li>
      {% else %}
        <li><a href="{% url 'account_login' %}" class="hover:text-pink-500">Login</a></li>
        <li><a href="{% url 'account_signup' %}" class="hover:text-pink-500">Sign Up</a></li>
      {% endif %}
      <li><button id="darkModeToggle" class="p-2 rounded-full bg-gray-700 hover:bg-gray-600 transition"><i data-lucide="moon" class="w-5 h-5 text-yellow-300"></i></button></li>
    </ul>

    <!-- Mobile Top Icons -->
<div class="flex md:hidden items-center gap-3 text-gray-200">
  {% if user.is_authenticated %}
    <!-- Chat -->
    <a href="{% url 'chat_list' %}" class="relative p-1">
      <i data-lucide="message-circle" class="w-5 h-5"></i>
      <span id="chat-notification-count-mobile" class="absolute -top-1 -right-1 bg-red-500 text-xs px-1 rounded-full hidden">0</span>
    </a>

    <!-- Profile -->
    <a href="{% url 'user_profile' %}" class="p-1"><i data-lucide="user" class="w-5 h-5"></i></a>

    <!-- Notifications -->
    <button id="notification-wrapper-mobile" class="relative p-1">
      <i data-lucide="bell" class="w-5 h-5"></i>
      <span id="notification-count-mobile" class="absolute -top-1 -right-1 bg-red-500 text-xs px-1 rounded-full hidden">0</span>
    </button>

    <!-- Swipe -->
    <a href="{% url 'swipes:swipe_page' %}" class="p-1"><i data-lucide="heart" class="w-5 h-5"></i></a>

    
<button id="darkModeToggleMobile" class="p-2 rounded-full bg-gray-700 hover:bg-gray-600 transition"><i data-lucide="moon" class="w-5 h-5 text-yellow-300"></i></b>
    <!-- Menu Toggle -->
    <button id="mobileMenuToggle" class="p-1"><i data-lucide="menu" class="w-5 h-5"></i></button>
  {% else %}
    <a href="{% url 'account_login' %}" class="p-1"><i data-lucide="log-in" class="w-5 h-5"></i></a>
    <a href="{% url 'account_signup' %}" class="p-1"><i data-lucide="user-plus" class="w-5 h-5"></i></a>
  {% endif %}
</div>

<!-- Mobile Slide Menu -->
<div id="mobile-slide-menu" class="fixed top-0 right-0 h-full w-64 bg-black dark:bg-gray-800 transform translate-x-full transition-transform duration-300 z-50 p-6">
  <button id="closeMobileMenu" class="mb-4 text-gray-300"><i data-lucide="x" class="w-5 h-5"></i></button>
  <ul class="flex flex-col gap-4 text-gray-200">
    {% if user.is_authenticated %}

    <!-- Likes -->
    <a href="{% url 'who_liked_me' %}" class="p-1"><i data-lucide="thumbs-up" class="w-5 h-5"></i>Likes</a>
      <!-- Matches -->
      <li>
        <a href="{% url 'match_results' %}" class="hover:text-pink-500 flex items-center gap-2">
          <i data-lucide="users" class="w-5 h-5"></i>Matches
        </a>
      </li>

    <!--Delete Profile-->
     <li>
      <a href="{% url 'delete_profile' %}" class="hover:text-red-500 flex items-center gap-2">
        <i data-lucide="trash-2" class="w-5 h-5"></i>Delete Profile
      </a>
    </li>

      <!-- Logout -->
      <li>
        <a href="{% url 'account_logout' %}" class="hover:text-pink-500 flex items-center gap-2">
          <i data-lucide="log-out" class="w-5 h-5"></i>Logout
        </a>
      </li>

    {% endif %}

    <!-- Public Pages -->
    <li><a href="{% url 'terms' %}" class="hover:text-pink-500">Terms & Conditions</a></li>
    <li><a href="{% url 'privacy' %}" class="hover:text-pink-500">Privacy Policy</a></li>
    <li><a href="{% url 'about' %}" class="hover:text-pink-500">About Us</a></li>
    <li><a href="{% url 'contact' %}" class="hover:text-pink-500">Contact</a></li>
  </ul>
</div>

  <!-- Mobile Notification Modal -->
  <div id="mobile-notification-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-end z-50">
    <div class="w-full bg-white dark:bg-gray-800 rounded-t-lg p-4 animate-slide-up max-h-[60vh] overflow-y-auto">
      <h2 class="text-lg font-bold mb-3">Notifications</h2>
      <div id="mobile-notification-list" class="space-y-2"></div>
      <button id="close-mobile-notifications" class="mt-4 w-full bg-red-500 text-white py-2 rounded">Close</button>
    </div>
  </div>
</nav>

<main class="container mx-auto mt-6 px-4 animate-fade-in">
  {% block content %}{% endblock %}
</main>

<!-- Footer -->
{% block footer %}
<footer class="bg-black dark:bg-gray-800 text-gray-300 mt-10">
  <div class="container mx-auto px-4 py-8 grid grid-cols-1 md:grid-cols-3 gap-6">

    <div>
      <a href="/" class="flex items-center gap-2 text-white font-bold text-lg">
        <i data-lucide="flame" class="w-5 h-5 text-pink-500"></i> Avadating
      </a>
      <p class="text-sm mt-2 text-gray-400">Connecting people with style.</p>
    </div>

    <div>
      <h3 class="text-white font-semibold mb-2">Quick Links</h3>
      <ul class="space-y-1 text-sm">
        <li><a href="{% url 'terms' %}" class="hover:text-pink-500">Terms & Conditions</a></li>
        <li><a href="{% url 'privacy' %}" class="hover:text-pink-500">Privacy Policy</a></li>
        <li><a href="/about/" class="hover:text-pink-500">About Us</a></li>
        <li><a href="/contact/" class="hover:text-pink-500">Contact</a></li>
      </ul>
    </div>

    <div>
      <h3 class="text-white font-semibold mb-2">Follow Us</h3>
      <div class="flex gap-4">
        <a href="#" class="hover:text-pink-500"><i data-lucide="facebook" class="w-5 h-5"></i></a>
        <a href="#" class="hover:text-pink-500"><i data-lucide="twitter" class="w-5 h-5"></i></a>
        <a href="#" class="hover:text-pink-500"><i data-lucide="instagram" class="w-5 h-5"></i></a>
        <a href="#" class="hover:text-pink-500"><i data-lucide="linkedin" class="w-5 h-5"></i></a>
      </div>
    </div>
  </div>

  <div class="border-t border-gray-700 mt-6 py-4 text-center text-sm text-gray-400">
    Â© 2025 <span class="font-semibold text-white">Avadating</span>. All rights reserved.
  </div>
</footer>
{% endblock footer %}

<script>
document.addEventListener("DOMContentLoaded", () => {
  lucide.createIcons();

  const htmlElement = document.documentElement;
  const toggleButtons = [
    document.getElementById('darkModeToggle'),
    document.getElementById('darkModeToggleMobile')
  ];

 // --- THEME TOGGLE ---
  function setTheme(theme) {
    htmlElement.classList.toggle('dark', theme === 'dark');
    localStorage.setItem('theme', theme);

    toggleButtons.forEach(btn => {
      if (!btn) return;
      btn.innerHTML = theme === 'dark'
        ? '<i data-lucide="sun" class="w-5 h-5 text-yellow-300"></i>'
        : '<i data-lucide="moon" class="w-5 h-5 text-yellow-300"></i>';
    });

    lucide.createIcons();
  }

  setTheme(localStorage.getItem('theme') || 'light');
  toggleButtons.forEach(btn =>
    btn?.addEventListener('click', () => {
      setTheme(htmlElement.classList.contains('dark') ? 'light' : 'dark');
    })
  );

  // --- NOTIFICATIONS ---
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function markNotificationsRead() {
    fetch("/notifications/mark-read/", {
      method: "POST",
      headers: {
        "X-CSRFToken": getCookie("csrftoken"),
        "Content-Type": "application/json"
      }
    }).then(() => {
      document.getElementById("notification-count")?.classList.add("hidden");
      document.getElementById("notification-count-mobile")?.classList.add("hidden");
    });
  }

  function fetchNotifications() {
    fetch("/notifications/fetch/", { credentials: "include" })
      .then(res => res.json())
      .then(data => {
        const badge = document.getElementById("notification-count");
        const dropdown = document.getElementById("notification-dropdown");

        badge.textContent = data.unread_count;
        badge.classList.toggle("hidden", data.unread_count === 0);
        dropdown.innerHTML = data.notifications.length
          ? data.notifications.map(n =>
              `<div class="px-4 py-2 border-b dark:border-gray-700">
                 <p class="text-sm">${n.message}</p>
                 <p class="text-xs text-gray-500">${new Date(n.timestamp).toLocaleString()}</p>
               </div>`
            ).join("")
          : `<p class="text-sm p-3 text-center">No notifications</p>`;

        const mobileBadge = document.getElementById("notification-count-mobile");
        const mobileList = document.getElementById("mobile-notification-list");

        mobileBadge.textContent = data.unread_count;
        mobileBadge.classList.toggle("hidden", data.unread_count === 0);
        mobileList.innerHTML = dropdown.innerHTML;
      });

    fetch("/chat/unread/", { credentials: "include" })
      .then(res => res.json())
      .then(data => {
        const unread = data.unread || 0;
        const chatCount = document.getElementById("chat-notification-count");
        const chatCountMobile = document.getElementById("chat-notification-count-mobile");

        chatCount.textContent = unread;
        chatCount.classList.toggle("hidden", unread === 0);

        chatCountMobile.textContent = unread;
        chatCountMobile.classList.toggle("hidden", unread === 0);
      });
  }

  // Desktop dropdown
  document.getElementById("notification-wrapper")?.addEventListener("click", () => {
    const dropdown = document.getElementById("notification-dropdown");
    dropdown.classList.toggle("hidden");
    if (!dropdown.classList.contains("hidden")) {
      markNotificationsRead();
    }
  });

  // Mobile modal
  document.getElementById("notification-wrapper-mobile")?.addEventListener("click", () => {
    document.getElementById("mobile-notification-modal").classList.remove("hidden");
    markNotificationsRead();
  });
  document.getElementById("close-mobile-notifications")?.addEventListener("click", () => {
    document.getElementById("mobile-notification-modal").classList.add("hidden");
  });

  // --- MOBILE SLIDE MENU ---
  const mobileMenu = document.getElementById("mobile-slide-menu");
  document.getElementById("mobileMenuToggle")?.addEventListener("click", () => {
    mobileMenu.classList.remove("translate-x-full");
  });
  document.getElementById("closeMobileMenu")?.addEventListener("click", () => {
    mobileMenu.classList.add("translate-x-full");
  });

  // Initial + interval fetch
  fetchNotifications();
  setInterval(fetchNotifications, 100000);
});
</script>


{% block scripts %}{% endblock %}
</body>
</html>
