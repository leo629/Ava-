{% load static %}
{% load crispy_forms_tags %}
<!DOCTYPE html>
<html lang="en" class="transition-colors duration-300">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}Ava Project{% endblock %}</title>

  <link rel="icon" type="image/png" href="{% static 'favicon.png' %}" />
  <meta name="description" content="Ava Project - Find connections that matter." />
  <meta name="author" content="Ava Team" />
  <meta name="theme-color" content="#111827" />

  <!-- TailwindCSS & Lucide Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          animation: {
            'fade-in': 'fadeIn 0.5s ease-in-out',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            }
          }
        }
      }
    };
  </script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <link rel="stylesheet" href="{% static 'css/account.css' %}" />
  {% block extra_head %}{% endblock %}
</head>

<body class="bg-gray-100 text-gray-900 dark:bg-gray-900 dark:text-gray-100 font-sans transition duration-300">

  <!-- Navbar -->
  <nav class="bg-black text-white py-3 shadow-lg dark:bg-gray-800">
    <div class="container mx-auto px-4 flex justify-between items-center">
      <a href="/" class="text-xl font-bold tracking-wide">discover</a>

      <!-- Hamburger -->
      <button id="menu-toggle" class="md:hidden focus:outline-none">
        <i data-lucide="menu" class="w-6 h-6"></i>
      </button>

      <!-- Nav Links -->
      <ul id="nav-links" class="hidden md:flex flex-col md:flex-row md:items-center gap-4 text-sm mt-4 md:mt-0">
        {% if user.is_authenticated %}
          <li><a href="{% url 'user_profile' %}" class="hover:text-gray-400 flex items-center gap-1"><i data-lucide="user" class="w-4 h-4"></i>Profile</a></li>
          <li><a href="{% url 'edit_profile' %}" class="hover:text-gray-400 flex items-center gap-1"><i data-lucide="edit" class="w-4 h-4"></i>Edit</a></li>
          <li><a href="{% url 'account_logout' %}" class="hover:text-gray-400 flex items-center gap-1"><i data-lucide="log-out" class="w-4 h-4"></i>Logout</a></li>
          <li><a href="{% url 'chat_list' %}" class="hover:text-gray-400 flex items-center gap-1"><i data-lucide="message-circle" class="w-4 h-4"></i>Chat</a></li>
          <li><a href="{% url 'swipe_page' %}" class="hover:text-gray-400 flex items-center gap-1"><i data-lucide="heart" class="w-4 h-4"></i>Swipe</a></li>
          <li><a href="{% url 'who_liked_me' %}" class="hover:text-gray-400 flex items-center gap-1"><i data-lucide="thumbs-up" class="w-4 h-4"></i>Likes</a></li>
          <li><a href="{% url 'match_results' %}" class="hover:text-gray-400 flex items-center gap-1"><i data-lucide="users" class="w-4 h-4"></i>Matches</a></li>

          <!-- Notifications -->
          <li class="relative">
            <div id="notification-wrapper" class="cursor-pointer relative">
              <i data-lucide="bell" class="w-5 h-5"></i>
              <span id="notification-count" class="absolute -top-1 -right-2 bg-red-500 text-white text-xs rounded-full px-1 hidden">0</span>
              <div id="notification-dropdown" class="hidden absolute right-0 mt-2 w-64 bg-white text-black rounded shadow-lg z-50 max-h-64 overflow-y-auto dark:bg-gray-800 dark:text-white">
                <p class="text-sm p-3 text-center">Loading notifications...</p>
              </div>
            </div>
          </li>
        {% else %}
          <li><a href="{% url 'account_login' %}" class="hover:text-gray-400">Login</a></li>
          <li><a href="{% url 'account_signup' %}" class="hover:text-gray-400">Sign Up</a></li>
        {% endif %}

        <!-- Dark Mode Toggle -->
        <li>
          <button id="darkModeToggle" class="ml-2 bg-gray-700 text-white px-2 py-1 rounded hover:bg-gray-600 transition text-sm">
            ðŸŒ™
          </button>
        </li>
      </ul>
    </div>
  </nav>

  <!-- Page Content -->
  <main class="container mx-auto mt-6 px-4 animate-fade-in">
    {% block content %}{% endblock %}
  </main>

  <!-- Scripts -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      lucide.createIcons();

      // Mobile nav toggle
      const toggle = document.getElementById("menu-toggle");
      const nav = document.getElementById("nav-links");
      toggle.addEventListener("click", () => {
        nav.classList.toggle("hidden");
      });

      // Dark Mode
      const toggleButton = document.getElementById('darkModeToggle');
      const htmlElement = document.documentElement;
      const iconMap = { dark: "â˜€ï¸", light: "ðŸŒ™" };
      toggleButton.textContent = iconMap[localStorage.getItem('theme') || 'light'];

      toggleButton.addEventListener('click', () => {
        const isDark = htmlElement.classList.toggle('dark');
        const theme = isDark ? 'dark' : 'light';
        localStorage.setItem('theme', theme);
        toggleButton.textContent = iconMap[theme];
      });

      // Notifications
      const bell = document.getElementById("notification-wrapper");
      const dropdown = document.getElementById("notification-dropdown");
      const badge = document.getElementById("notification-count");

      if (bell) {
        bell.addEventListener("click", () => {
          dropdown.classList.toggle("hidden");
          badge.classList.add("hidden");
        });

        function fetchNotifications() {
          fetch("/notifications/fetch/")
            .then(res => res.json())
            .then(data => {
              const count = data.unread_count;
              badge.textContent = count;
              count > 0 ? badge.classList.remove("hidden") : badge.classList.add("hidden");

              dropdown.innerHTML = data.notifications.map(n => `
                <div class="px-4 py-2 border-b border-gray-200 dark:border-gray-700">
                  <p class="text-sm">${n.message}</p>
                  <p class="text-xs text-gray-500">${new Date(n.timestamp).toLocaleString()}</p>
                </div>
              `).join("") || `<p class="text-sm p-3 text-center">No notifications</p>`;
            })
            .catch(() => {
              dropdown.innerHTML = `<p class="text-sm p-3 text-center text-red-500">Error loading notifications</p>`;
            });
        }

        fetchNotifications();
        setInterval(fetchNotifications, 10000);
      }

      // Location Update
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
          fetch("/update_location/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{ csrf_token }}",
            },
            body: JSON.stringify({
              latitude: position.coords.latitude,
              longitude: position.coords.longitude
            })
          });
        });
      }
    });
  </script>
  {% block scripts %}{% endblock %}
</body>
</html>

